{{/* Empty line */}}
Helm Release {{ .Release.Name }} installed in namespace {{ .Release.Namespace }}.
{{- $yes := "YES" }}
{{- $no := "NO " }}
{{- $backstageInstalled := $yes }} 
{{- $postgresBackstageInstalled := $no }}
{{- $serverlessOperatorInstalled := $no }}
{{- $knativeServingInstalled := $no }}
{{- $knativeEventingInstalled := $no }}
{{- $sonataFlowOperatorInstalled := $no }} 
{{- $sonataFlowPlatformInstalled := $no }}
{{- $timeout := "--timeout=5m" }}

<<<<<<< HEAD
=======
{{- if .Values.backstage.upstream.postgresql.enabled }}
{{- $postgresBackstageInstalled = $yes }}
{{- end }}


{{- if .Values.tags.openshift }}
>>>>>>> a486033 (merging janus-idp-workflows-helm WIP)
{{- if .Values.serverlessOperator.enabled }}
{{- $unmanagedSubscriptionExists := include "unmanaged-resource-exists" (list "operators.coreos.com/v1alpha1" "Subscription" .Values.serverlessOperator.openshift.subscription.namespace "serverless-operator" .Release.Name) }}
{{- if eq $unmanagedSubscriptionExists "false" }}
{{- $serverlessOperatorInstalled = $yes }}
{{- end }}
{{- end }}

{{- end }}



{{- $unmanagedNamespaceExists := include "unmanaged-resource-exists" (list "v1" "Namespace" "" "knative-serving" .Release.Name) }}
{{- $unmanagedKnativeEventingExists := include "unmanaged-resource-exists" (list "operator.knative.dev/v1beta1" "KnativeEventing" "knative-eventing" "knative-eventing" .Release.Name) }}
{{- if eq $unmanagedKnativeEventingExists "false" }}
{{- $knativeEventingInstalled = $yes }}
{{- end }}
{{- $unmanagedKnativeServingExists := include "unmanaged-resource-exists" (list "operator.knative.dev/v1beta1" "KnativeServing" "knative-serving" "knative-serving" .Release.Name) }}
{{- if eq $unmanagedKnativeServingExists "false" }}
{{- $knativeServingInstalled = $yes }}
{{- end }}


{{- if .Values.tags.kubernetes }}
{{- if .Values.serverlessOperator.enabled }}
{{- $serverlessOperatorInstalled = $yes }}
{{- end }}
{{- if .Values.sonataFlowOperator.enabled }}
{{- $sonataFlowOperatorInstalled = $yes }}
{{- $sonataFlowPlatformInstalled = $yes }}
{{- end }}
{{- end }}


Components                   Installed   Namespace
====================================================================
<<<<<<< HEAD
Backstage                    {{ $backstageInstalled }}        {{ .Values.rhdhOperator.subscription.namespace }}
Postgres DB - Backstage      {{ $postgresBackstageInstalled }}        {{ .Values.rhdhOperator.subscription.namespace }}
Red Hat Serverless Operator  {{ $serverlessOperatorInstalled }}        {{ .Values.serverlessOperator.subscription.namespace }}     
=======
Backstage                    {{ $backstageInstalled }}        {{ .Release.Namespace }}
Postgres DB - Backstage      {{ $postgresBackstageInstalled }}        {{ .Release.Namespace }}

{{- if .Values.tags.openshift }}
Red Hat Serverless Operator  {{ $serverlessOperatorInstalled }}        {{ .Values.serverlessOperator.openshift.subscription.namespace }}     
SonataFlow Operator          {{ $sonataFlowOperatorInstalled }}        {{ .Values.sonataFlowOperator.openshift.subscription.namespace }}
{{- end }}
{{- if .Values.tags.kubernetes }}
Serverless Operator          {{ $serverlessOperatorInstalled }}        {{ .Values.serverlessOperator.kubernetes.namespace }}     
SonataFlow Operator          {{ $sonataFlowOperatorInstalled }}        {{ .Values.global.orchestrator.namespace }}
{{- end }}
>>>>>>> a486033 (merging janus-idp-workflows-helm WIP)
KnativeServing               {{ $knativeServingInstalled }}        knative-serving
KnativeEventing              {{ $knativeEventingInstalled }}        knative-eventing
SonataFlowPlatform           {{ $sonataFlowPlatformInstalled }}        {{ .Values.global.orchestrator.namespace }}
Data Index Service           {{ $sonataFlowPlatformInstalled }}        {{ .Values.global.orchestrator.namespace }}
Job Service                  {{ $sonataFlowPlatformInstalled }}        {{ .Values.global.orchestrator.namespace }}
{{/* Empty line */}}

{{- if gt (len .Values.global.orchestrator.sonataflows) 0 }}
Workflows deployed on namespace {{ .Values.global.orchestrator.namespace }}:
{{- range $v := .Values.global.orchestrator.sonataflows }}
{{ $v.name }}
{{- end }}
{{- else }}
No workflows deployed.
{{- end }}

Run the following commands to wait until the services are ready:
{{- if .Values.tags.openshift }}
{{- if eq $serverlessOperatorInstalled $yes }}
  oc wait -n {{ .Values.serverlessOperator.openshift.subscription.namespace }} deploy/knative-openshift --for=condition=Available {{ $timeout }}
{{- end }}
{{- if eq $knativeEventingInstalled $yes }}
  oc wait -n knative-eventing knativeeventing/knative-eventing --for=condition=Ready {{ $timeout }}
{{- end }}
{{- if eq $knativeServingInstalled $yes }}
  oc wait -n knative-serving knativeserving/knative-serving --for=condition=Ready {{ $timeout }}
{{- end }}
{{- if eq $sonataFlowOperatorInstalled $yes }}
  oc wait -n {{ .Values.sonataFlowOperator.openshift.subscription.namespace }} deploy/sonataflow-operator-controller-manager --for=condition=Available {{ $timeout }}
{{- end }}
{{- if eq $sonataFlowPlatformInstalled $yes }}
  oc wait -n {{ .Values.global.orchestrator.namespace }} sonataflowplatform/sonataflow-platform --for=condition=Succeed {{ $timeout }}
{{- end }}
{{- if eq $sonataFlowPlatformInstalled $yes }}
  oc wait -n {{ .Values.global.orchestrator.namespace }} deploy/sonataflow-platform-data-index-service --for=condition=Available {{ $timeout }}
{{- end }}
{{- if eq $sonataFlowPlatformInstalled $yes }}
  oc wait -n {{ .Values.global.orchestrator.namespace }} deploy/sonataflow-platform-jobs-service --for=condition=Available {{ $timeout }}
{{- end }}
{{- if eq $postgresBackstageInstalled $yes }}
  oc wait -n {{ .Values.rhdhOperator.subscription.namespace }} pod/backstage-psql-backstage-0 --for=condition=Ready {{ $timeout }}
{{- end }}
{{- if eq $backstageInstalled $yes }}
  oc wait -n {{ .Values.rhdhOperator.subscription.namespace }} backstage backstage --for=condition=Deployed=True
  oc wait -n {{ .Values.rhdhOperator.subscription.namespace }} deploy/backstage-backstage --for=condition=Available {{ $timeout }}
{{- end }}
{{- end }}

{{- $ns := .Values.global.orchestrator.namespace }}
{{- if (gt (len .Values.global.orchestrator.sonataflows) 0) }}
{{/* Empty line */}}
<<<<<<< HEAD
Run the following commands to wait until the workflow builds are done and workflows are running on namespace {{ .Values.orchestrator.namespace }}:
{{- range $v := .Values.orchestrator.sonataflows }}
=======
Run the following commands to wait until the workflow builds are done and workflows are running on namespace {{ .Values.global.orchestrator.namespace }}:
{{- range $v := .Values.global.orchestrator.sonataflows }}
  oc wait -n {{ $ns }} sonataflow/{{ $v.name }} --for=condition=Built --timeout=15m
>>>>>>> a486033 (merging janus-idp-workflows-helm WIP)
  oc wait -n {{ $ns }} sonataflow/{{ $v.name }} --for=condition=Running {{ $timeout }}
{{- end }}
{{- end }}
